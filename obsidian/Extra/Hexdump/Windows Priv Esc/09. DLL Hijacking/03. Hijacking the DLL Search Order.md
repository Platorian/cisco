## Hijacking DLL Search Order

If you do not specify a full path when loading a DLL, when Microsoft tried to find a DLL, a specific search order is followed.

- Absolute Path
```sh
hinstLib = LoadLibrary(TEXT("C:\\Users\\Quickemu\\Downloads\\lib.dll"));
```

- Relative Path
```sh
hinstLib = LoadLibrary(TEXT("lib.dll"));
```

The specific search order is the following one

1. The folder specified by `lpFileName`
2. . System folder, get using `GetSystemDirectory()`
3. . 16-bit system folder
4. . Windows directory, get using `GetWindowsDirectory()`
5. . Current directory
6. . Directories listed in the `PATH`

In this case we have a problem when the attacker is able to introduce a malicious DLL in a position that has priority over the regular DLL. For example:

- The regular DLL is found within the Windows Directory (C:\Windows)
- The malicious DLL is found within the System Folder (C:\Windows\System32)

---
## References

ListDLLs is a utility that reports the DLLs loaded into processes: https://learn.microsoft.com/en-us/sysinternals/downloads/listdlls

Compiling a DLL using MingGW: https://malicious.link/posts/2020/compiling-a-dll-using-mingw/

Dynamic-link library search order: https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order