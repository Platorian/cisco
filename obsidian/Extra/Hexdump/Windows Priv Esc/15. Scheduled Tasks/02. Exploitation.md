## Enumeration

**List all scheduled tasks**
```powershell
Get-ScheduledTask
```


```powershell
schtasks /query
```

**List Tasks in a Specific Folder**
```powershell
Get-ScheduledTask | Where-Object {$_.TaskPath -eq "\Microsoft\Windows\Shell\"}
```

---

**List tasks with detailed information**
```powershell
Get-ScheduledTask -TaskName "MyTask" | Get-ScheduledTaskInfo
```


```powershell
schtasks /query /FO LIST /V
```


```powershell
Get-ScheduledTask -TaskName "XblGameSaveTask" | Format-List *
```

---

**Extract binary path and arguments of services**
```powershell
(Get-ScheduledTask -TaskName "XblGameSaveTask").Actions
```


```powershell
Get-ScheduledTask | ForEach-Object { $_.Actions }
```

---

**Export task configuration as XML**
```powershell
Export-ScheduledTask -TaskName "XblGameSaveTask" -TaskPath "\Microsoft\XblGameSave\"
```

## Creation and Deletion

Simple task that runs when user logins to execute `notepad.exe`
```powershell
$action = New-ScheduledTaskAction -Execute "notepad.exe"
$trigger = New-ScheduledTaskTrigger -AtLogOn
Register-ScheduledTask -TaskName "MyTask" -Action $action -Trigger $trigger -User "quickem-h5dsq1v\quickemu"
```

Delete task
```powershell
Unregister-ScheduledTask -TaskName "SimpleTask" -Confirm:$false
```

## Exploitation

Define task config:
```powershell 
$Action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-File C:\Users\Quickemu\tasks\test1.ps1"
$Trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Minutes 1) -RepetitionDuration (New-TimeSpan -Days 365)
$Principal = New-ScheduledTaskPrincipal -UserId "SYSTEM" -LogonType ServiceAccount -RunLevel Highest
```

Register task:
```powershell 
Register-ScheduledTask -TaskName "SimpleTask" -Action $Action -Trigger $Trigger -Principal $Principal
```

 In the definition we see that we're executing the `C:\Users\Quickemu\tasks\test1.ps1` file using `powershell.exe` every minute for an entire year, and the task is executed as the `SYSTEM` account.
```powershell 
Unregister-ScheduledTask -TaskName "SimpleTask" -Confirm:$false
```

---
##  References

 Task Scheduler for developers: <https://learn.microsoft.com/it-it/windows/win32/taskschd/task-scheduler-start-page

Course Material: https://github.com/LeonardoE95/yt-en/blob/main/src/2024-12-16-windows-privesc-scheduled-tasks/content/notes.txt

