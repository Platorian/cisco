- Part 1: Perform Reflective Cross Site Scripting Exploits
- Part 2: Perform Stored Cross Site Scripting Exploits

# Instructions

## Part 1: Perform Reflective Cross Site Scripting Exploits

A Reflected XSS attack is one in which a malicious script is reflected off a web server to the user's browser. The script is activated through a link that the victim clicks. This will send a request to the website that has a vulnerability that enables execution of the malicious script.

### Step 1: Log into DVWA.

1. From the Kali Linux VM, open a browser and navigate to the DVWA application.
2. Enter the following URL into the browser [http://10.6.6.13](http://10.6.6.13).
3. At the login prompt, enter the credentials: **admin**/**password**.

### Step 2: Perform a Reflected XSS attack at Low security level.

1. Select **DVWA Security** in the left menu and select **Low** in the Security Level dropdown. Click **Submit**.
2. Select **XSS (Reflected)** from the left menu.
3. Type the string **Reflected_Test** in the **What's your name?** box and click **Submit**.

You will see the message **Hello Reflected_Test** appear.

4. Enter **CTRL+U** on the keyboard to view the source code of the page.
5. Search for the string **Hello Reflected_Test** by entering CTRL+F to open a search box.

The presence of the string in the page source HTML indicates that values entered in a user response text field are inserted into the source code for the page. This indicates to an attacker that the page may be vulnerable to reflected XSS attacks.

6. Close the source code window and return to the Reflected XSS Vulnerability page.
7. Enter the following payload in the **What’s your name?** box and click **Submit**.

```java
<script>alert("You are hacked!")</script>
```

An alert popup box will appear with the words **You are hacked!**. This means the site is vulnerable to Reflected XSS attacks and we have successfully exploited the vulnerability.

8. Select and copy the URL for the compromised page. Open a new browser tab and paste the URL into the URL field and press `<Enter>.`

You should see the same web page appear displaying the **You are hacked!** popup box. This means that if a user opens the URL a malicious script will execute. The alert box is used to simulate a malicious script in this lab.

In an ethical hacking engagement, you would try inserting a simple test script into input fields to see if the script executes. If so, the website is vulnerable to reflected XSS attacks. You could then distribute the link in a phishing attack to determine the level of security awareness among your customers’ employees.

### Step 3: Perform a Reflected XSS attack at Medium security level.

You will attempt the same attack, but this time the security level of the Web site will Medium.

1. Select **DVWA Security** in the left menu and select **Medium** in the Security Level dropdown. Click **Submit**.
2. Select **XSS (Reflected)** in the left menu.
3. Again, enter the following payload in the **What's your name?** box and click **Submit**.

```java
<script>alert("You are hacked!")</script>
```

You will see a Hello response, but this time no pop up will appear. This indicates that the script did not execute. Note that the script is displayed as literal text.

We can analyze the code in the backend of the web site to investigate the reason.

4. Click the **View Source** button on the bottom right of the page and review the PHP code.

**Note**: On a real web server, we would not have access to this backend source code, but here on DVWS we do.

5. Note the line:

```java
$name = str_replace ( '<script>', '',  $_GET[ 'name' ] );
```

This source code creates a filter, with `str_replace()` function, that removes the `**<script>` tag in our payload and replaces it with a null value. This renders the payload script ineffective, so the attack failed, and no popup window is displayed. Because this script is only filtering out `<script>` in lower case, we can try and get around the filter by using a different tag in the payload. We will use `<ScRipt>.`

6. Close the source code window and return to the Reflected XSS Vulnerability page.
7. Enter the following payload in the **What's your name?** box and click **Submit**.

```java
<ScRipt>alert("You are hacked!")</ScRipt>
```

### Step 4: Perform a Reflective XSS attack at High security level.

The same attack will be attempted, but this time the security level of the website will be High.

1. Select **DVWA Security** in the left menu and select **High** in the Security Level dropdown. Click **Submit**.
2. Select **XSS (Reflected)** in the left menu.
3. Enter the following payload in the **What's your name?** box and click **Submit**. (Note the use of underscores to replace spaces.)

```java
<ScRipt>alert("You_are_hacked!")</ScRipt>
```

There is a Hello message and no alert pop up box. Again, we can analyze the backend source code to investigate.

4. Click the **View Source** button and review the PHP code.

Note the following line:

**$name = preg_replace( '/<(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i', '', $_GET[ 'name' ] );**

In this code, the developer used a regular expression to replace any form of the `<script>`  tag, no matter what case of the characters is used, with a null value.

5. To bypass this filter, we must use another HTML tag instead of **`<script>`** to attack the site.

Close the source code window and return to the Reflected XSS Vulnerability page.

6. Enter the following payload in the **What's your name?** box and click **Submit**. (Note the use of underscores to replace spaces.)

```java
<img src=x onerror=alert("You_are_hacked!")>
```

The XSS popup box will appear this time. We successfully bypassed the filter and exploited the Reflected XSS vulnerability in DVWA at High level security.

---

## Part 2: Perform Stored Cross Site Scripting Exploits

With the stored XSS exploit, you enter a malicious script through user input and the script is stored on the target server in a message forum, database, visitor log, or comment field. When a user visits the target, the server exposes the user to the malicious code.

### Step 1: Perform a Stored XSS attack at Low security level.

Exploiting stored XSS at low level security is easy because there are no security measures in place. You can simply submit a `<script>` to achieve the exploit.

1. Select **DVWA Security** in the left menu and select **Low** in the Security Level dropdown. Click **Submit**.
2. Select **XSS (Stored)** in the left menu.
3. Type the string **XSS Test#1** in the **Name*** field and type **Stored XSS Test** in the **Message *** field. click **Sign Guestbook**.
4. Enter **CTRL+U** on the keyboard to view the page source code. Enter **CTRL+F** to search for the **Test#1** and **Stored XSS Test** strings.

Both strings, **Test#1** and **Stored XSS Test**, will be in the page source code indicating that the two input fields may be vulnerable to a Stored XSS attack.

5. Close the source code window and return to the Stored XSS Vulnerability page.
6. Enter **Test#1** in the **Name** **box** and enter the following payload in the **Message** **field** and click **Sign Guestbook**.

```java
<script>alert("You are hacked!")</script>
```

An XSS alert popup box will appear with the words **You are hacked!**. This means the site was vulnerable to stored XSS attacks and we have successfully exploited the vulnerability.

7. Refresh the page. If alerted, click **Resend** to display the page. The XSS alert popup box will appear again.

Because the XSS payload is stored in the guestbook, the alert popup box will appear each time the page is refreshed.

8. Before proceeding to the next step, clear the XSS payload from the page. Click **Setup / Reset DB** in the left menu then click **Create / Reset Database**.

### Step 2: Perform a Stored XSS attack at Medium security level.

The same attack will be attempted, but this time the security level of the Web site will be changed to Medium.

Exploiting reflected XSS at medium level security is not difficult. Using `<script>` will be rejected but changing it to a different case such as `<ScRipt>` will bypass the security and achieve the exploit.

1. Select **DVWA Security** in the left menu and select **Medium** in the Security Level options dropdown. Click **Submit**.
2. Select **XSS (Stored)** in the left menu.
3. Type the string **XSS Test#1** in the **Name*** field and type **Stored XSS Test** in the **Message*** ***field.*** click **Sign Guestbook**.
4. Enter **CTRL+U** on the keyboard to view the page source code. Enter **CTRL+F** to search for the **Test#1** and **Stored XSS Test** strings.

Both strings will be in the page source code indicating that the two input fields may be vulnerable to a Stored XSS attack.

5. Close the source code window and return to the Vulnerability page.
6. Enter **Test#1** in the **Name*** **box** and enter the following payload in the **Message** ***box*** and click **Sign Guestbook**.

```java
<script>alert("You are hacked!")</script>
```

No popup box should appear. Refreshing the page should not cause the alert popup box to appear either.

This means that there is code in the backend that is sanitizing the user input from the **Message** **field** to prevent scripts from being submitted. You can see the modified input in the last rectangle message box below the input fields.

You will see two blocks of code with the word **Sanitize**. The first block of code, under **// Sanitize message input**, contains two PHP functions for performing input sanitization. The **strip_tags()** function removes all html tags from the message field before storing them in the database. The **htmlspecialchars()** function converts all special characters into equivalent HTML entities so they are not reflected back in the browser.

- *It added slashes before the quotation marks in the alert text. This “escaped” the quotation mark characters and which made them display in the output.*

The second block of code, under **// Sanitize name input**, performs input sanitation on the **Name** field. It contains the **str_replace()** function which replaces any occurrence of the **`<script>`** tag with a null value. This disables the script completely.

We can attempt to bypass the security on the **Name** field by using some other payload that does not contain **`<script>`** tags.

8. Close the source code window.
9. Before entering any payload into the **Name** field, the max character length restriction of 10 characters on the field must be increased. This is a client-side setting so it is easy to change with the following steps:
    1. Right-click in the **Name** field and select **Inspect**. This opens the Web Developer Tools window and displays the page source code.
    2. Find and double-click **maxlength** in the page source and change it from **10** to **100**. The maxlength property is inside the `<input>` tag for the text field.
    3. Press **Enter** on the keyboard to apply the changes.
    4. Close the Web Developer’s Tools Window

With the **maxlength** restriction changed, the XSS payload can now be entered into the **Name** field.

**Note**: Changing the **maxlength** parameter does not persist. If you refresh the page, for example, the setting needs to be changed again.

10. Return to the Vulnerability page and enter the following payload in the **Name*** field.

```java
<ScRipt>alert("You are hacked!")</ScRipt>
```

11. In the **Message*** field you can type any text you like and then click **Sign Guestbook**.

An XSS alert popup box will appear with the words **You are hacked!**.

Because the XSS payload is stored in the guestbook, the alert popup box will appear each time the page is refreshed or each time other users visit the page.

The popup confirms you have successfully exploited Stored XSS vulnerability at the Medium level of security.

12. Before proceeding to the next step, clear the XSS payload from the page. Click **Setup / Reset DB** in the left menu then click **Create / Reset Database**.

### Step 3: Perform a Stored XSS attack at High security level.

You will attempt the same attack, but this time the security level of the Web site will be set to High.

At high level the security code whitelists `<scripts>` and all else is rejected. However, other tags, such as svg will work.

1. Select **DVWA Security** in the left menu and select **High** in the Security Level dropdown. Click **Submit**.
2. Select **XSS (Stored)** in the left menu.
3. Type the string **Test#1** in the **Name*** field and type **Stored XSS Test** in the **Message*** field. Click **Sign Guestbook**.
4. Enter **CTRL+U** on the keyboard to view the page source code. Enter **CTRL+F** to search for the **Test#1** and **XSS Test** strings.

Both **Test#1** and **XSS Test** should be in the page source code indicating that the two input fields may be vulnerable to a Stored XSS attack.

5. Close the page source code tab and return to the Vulnerability page.
6. Enter **Test#1** in the **Name*** box and enter the following payload in the **Message*** box and click **Sign Guestbook**.

```java
<ScRipt>alert("You are hacked!")</ScRipt>
```

No popup box will appear. Refreshing the page will not cause the alert popup box to appear either.

This means that there is code in the site backend that is sanitizing the user input from the **Message*** field.

7. Click the **View Source** button and review the PHP source code and investigate.

You will see two blocks of code. As before with the Medium security, the first block of code, under **// Sanitize message input**, contains two php functions for performing input sanitization. The **strip_tags()** function removes all html tags from the message field before storing them in the database. The **htmlspecialchars()** function converts all special characters into equivalent HTML characters so they are not reflected back in the browser.

The second block of code, under **// Sanitize name input**, is performing input sanitation on the **Name*** field. It contains the **preg_replace()** function. This function uses a regular expression to replace any occurrence of the **`<script>`** tag, regardless of character case, with a null value.

We can attempt to bypass the security on the **Name*** field by using some other payload that does not contain **`<script>`** tags.

8. Before entering any payload into the **Name*** field, it will be necessary to change the max character length restriction on the field, as was done above.

With the **maxlength** restriction changed, the XSS payload can now be entered into the **Name*** field.

9. Return to the Vulnerability page and enter the following payload in the **Name*** field. (Note the use of underscores to replace spaces.)

```java
<svg onload=alert("You_are_hacked!")>
```

10. In the **Message*** field, you can type any text you like and then click **Sign Guestbook**.

An XSS alert popup box will appear with the message "**You_are_hacked!**".

Because the XSS payload is stored in the guestbook, the alert popup box will appear each time the page is refreshed.

The popup confirms you have successfully exploited a Stored XSS vulnerability at High security level.

11. Before proceeding to the next step, clear the XSS payload from the page. Click **Setup / Reset DB** in the left menu then click **Create / Reset Database**.

### Step 4: Perform a stored iframe exploit.

1. Select **DVWA Security** in the left menu and select **Low** in the Security Level dropdown. Click **Submit**.
2. Select **XSS (Stored)** in the left menu.
3. Type the string **iframe** in the **Name*** field and type the following message in the **Message*** field. click **Sign Guestbook**.

### Step 5: Perform a stored cookie exploit.

Stealing the cookies of website visitors has security implications. Cookies contain information about how and when users visit a web site and sometimes authentication information, such as usernames and passwords. Without proper security measures, a threat actor can capture cookies and use them to impersonate specific users and gain access to their information and accounts.

1. Select **DVWA Security** in the left menu and select **Low** in the Security Level options dropdown. Click **Submit**.
2. Select **XSS (Stored)** in the left menu.
3. Type the string **cookie** in the **Name*** field and type the following message in the **Message*** field. click **Sign Guestbook**.

```java
<script>alert(document.cookie)</script>
```

A popup box with the cookie will be presented. This is a cookie that PHP uses to keep of track of running sessions.

An exploit could modify the XSS script to have the cookie sent to another destination rather than just displaying it.

4. Click **OK** in the pop-up box.
5. Try to steal cookies at the medium and high security levels using techniques that you have learned in this lab.

Example from DVWA:
```java
PHPSESSID=2hh167qk38euoshnnq1r3nf2s7; security=medium
PHPSESSID=2hh167qk38euoshnnq1r3nf2s7; security=high
```

---

Skills Check

**Q.** You are testing the Pixel Paradise reviews forum by submitting the following text in the review input field:

_This game is great!_ _`<script src=”http://protego.com/hack_message.png”></script>`_

When you check for the result of your post, you see the following:

_This game is great! src=”http://protego.com/hack_message.png”>_

What do you think happened?

**A.** As seen in the lab, backend code has sanitized the input by removing the script tags from the message. It has posted the script text however, indicating that protections against stored XSS may be weak.


