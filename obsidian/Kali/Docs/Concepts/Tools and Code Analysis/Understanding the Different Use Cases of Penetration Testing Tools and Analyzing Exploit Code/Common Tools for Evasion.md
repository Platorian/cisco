n a pen testing engagement, you typically want to maintain stealth and try to evade and circumvent any security controls that the organization may have in place. Several tools and techniques can be used for evasion, including the following:

- Veil
- Tor
- Proxychains
- Encryption
- Encapsulation and tunneling using DNS and protocols such as NTP

**Veil**

Veil is a framework that can be used with Metasploit to evade antivirus checks and other security controls. You can download Veil from [_https://github.com/Veil-Framework/Veil_](https://github.com/Veil-Framework/Veil) and obtain detailed documentation from [_https://www.veil-framework.com_](https://www.veil-framework.com/). 

Select each of the following steps for a Veil example.

**Step 1. Launch Veil**

After using the veil command to launch Veil, the Veil menu is displayed, as shown in Figure 10-19. 

**_Figure 10-19_** _- Veil’s Main Menu_

![[Pasted image 20240620072959.png]]

**Step 2. Select Evasion**

To use Veil for evasion, select the first option (number 1), as demonstrated in Figure 10-20. Veil then shows the available payloads and Veil commands.

**_Figure 10-20_** _- Using Veil for Evasion_

![[Pasted image 20240620073018.png]]

**Step 3. List the Payloads**

To list the available payloads, use the **list** command, and you see the screen in Figure 10-21.

**_Figure 10-21_** _- Veil’s Available Payloads_

![[Pasted image 20240620073122.png]]

**Step 4. Install a Payload**

In Figure 10-22, the Meterpreter reverse TCP payload is used. After you select the payload, you have to set the local host (LHOST) and then use the **generate** command to generate the payload.

Figure 10-22 shows the default Python installer being used to generate the payload. 

**_Figure 10-22_** _- Configuring the LHOST and Generating the Payload_

![[Pasted image 20240620073221.png]]

**Step 5. Verify Payload File Location**

Once the payload is generated, the screen shown in Figure 10-23 is displayed. The top portion of Figure 10-23 lists the locations of the payload executable, the source code, and the Metasploit resource file.

**_Figure 10-23_** _- Displaying the Locations of the Payload Executable, Source Code, and Metasploit Resource File_

![[Pasted image 20240620073510.png]]

---

**Tor**

Many people use tools such as Tor for privacy. Tor is a free tool that enables its users to surf the Web anonymously. Tor works by “routing” IP traffic through a free worldwide network consisting of thousands of Tor relays. It constantly changes the way it routes traffic in order to obscure a user’s location from anyone monitoring the network. Tor’s name is an acronym of the original software project’s name, “The Onion Router.”

**NOTE** Some types of malware use Tor to cover their tracks.

Tor enables users to evade and circumvent security monitoring and controls because it’s hard to attribute and trace back the traffic to the user. Its “onion routing” is accomplished by encrypting the application layer of a communication protocol stack that’s “nested” much like the layers of an onion. The Tor client encrypts the data multiple times and sends it through a network or circuit that includes randomly selected Tor relays. Each of the relays decrypts a layer of the onion to reveal only the next relay so that the remaining encrypted data can be routed on to it. Figure 10-24 shows a screenshot of the Tor browser. It shows the Tor circuit when the user accessed theartofhacking.org from the Tor browser. It first went to a host in France and then to a host in Hungary and then again to France, and finally to theartofhacking.org.

**_Figure 10-24_** _- The Tor Browser_

![[Pasted image 20240620074002.png]]

**TIP** A Tor exit node is basically the last Tor node, or the “gateway,” where the Tor encrypted traffic “exits” to the Internet. A Tor exit node can be targeted to monitor Tor traffic. Many organizations block Tor exit nodes in their environment. The Tor project has a dynamic list of Tor exit nodes that makes this task a bit easier.

---

**Proxychains**

Proxychains can be used for evasion, as it is a tool that forces any TCP connection made by a specified application to use Tor or any other SOCKS4, SOCKS5, HTTP, or HTTPS proxy. You can download Proxychains from [_https://github.com/haad/proxychains_](https://github.com/haad/proxychains).

---

**Encryption**

Encryption has great benefits for security and privacy, but the world of incident response and forensics can present several challenges. Even law enforcement agencies have been fascinated with the dual-use nature of encryption. When protecting information and communications, encryption has numerous benefits for everyone from governments and militaries to corporations and individuals. On the other hand, those same mechanisms can be used by threat actors as a method of evasion and obfuscation. Historically, even governments have tried to regulate the use and exportation of encryption technologies. A good example is the Wassenaar Arrangement, which is a multinational agreement whose goal is to regulate the export of technologies like encryption.

As another example, the U.S. Federal Bureau of Investigation (FBI) has tried to force vendors to leave certain investigative techniques in their software and devices. Another example is the alleged U. S. National Security Agency (NSA) backdoor in the Dual Elliptic Curve Deterministic Random Bit Generator (Dual_EC_DRBG), which allows plaintext extraction of any algorithm seeded by this pseudorandom number generator.

Some people have bought into the “encrypt everything” idea. However, encrypting everything would have very serious consequences – not only for law enforcement agencies but for incident response professionals. Something to remember about the concept of “encrypt everything” is that the deployment of end-to-end encryption is difficult and can leave unencrypted data at risk of attack.

Many security products (including next-generation IPSs and next-generation firewalls) can intercept, decrypt, inspect, and re-encrypt or even ignore encrypted traffic payloads. Some people consider this an on-path (formerly man-in-the-middle [MITM]) matter and have privacy concerns. On the other hand, you can still use metadata from network traffic and other security event sources to investigate and solve security issues. You can obtain a lot of good information by leveraging NetFlow, firewall logs, web proxy logs, user authentication information, and even passive DNS (pDNS) data. In some cases, the combination of these logs can make the encrypted contents of malware payloads and other traffic irrelevant – if you can detect their traffic patterns in order to remediate an incident.

It is a fact that you need to deal with encrypted data – but you need to do so in transit or “at rest” on an endpoint or server. If you deploy web proxies, you need to assess the feasibility in your environment of HTTP connections being secure against on-path attacks.

**TIP** It is important to recognize that, from a security monitoring perspective, it’s technically possible to monitor some encrypted communications. However, from a policy perspective, it’s an especially difficult task, depending on your geographic location and local laws related to privacy (for example, GDPR). There are technologies like Cisco’s Encrypted Traffic Analytics (ETA) that can detect malicious activities (malware behavior) without the need to decrypt packets.

---

**Encapsulation and Tunneling Using DNS and Protocols Such as NTP**

Threat actors have used many different nontraditional techniques to steal data from corporate networks without being detected. For example, they have sent stolen credit card data, intellectual property, and confidential documents over DNS by using tunneling. As you probably know, DNS is a protocol that enables systems to resolve domain names (for example, theartofhacking.org) into IP addresses (for example, 104.27.176.154). DNS is not intended for a command channel or even tunneling. However, attackers have developed software that enables tunneling over DNS. These threat actors like to use protocols that are not designed for data transfer because they are less inspected in terms of security monitoring. Undetected DNS tunneling (also known as _DNS exfiltration_ ) presents a significant risk to any organization.

In many cases, malware uses Base64 encoding to put sensitive data (such as credit card numbers and personally identifiable information) in the payload of DNS packets to cybercriminals. The following are some examples of encoding methods that attackers may use:

- Base64 encoding
- Binary (8-bit) encoding
- NetBIOS encoding
- Hex encoding

Several utilities have been created to perform DNS tunneling (for good reasons as well as harmful). The following are a few examples:

- **DeNiSe:** This Python tool is for tunneling TCP over DNS. You can download DeNiSe from [_https://github.com/mdornseif/DeNiSe_](https://github.com/mdornseif/DeNiSe).
- **dns2tcp:** Written by Olivier Dembour and Nicolas Collignon in C, dns2tcp supports KEY and TXT request types. You can download dns2tcp from [_https://github.com/alex-sector/dns2tcp_](https://github.com/alex-sector/dns2tcp).
- **DNScapy:** Created by Pierre Bienaimé, this Python-based Scapy tool for packet generation even supports SSH tunneling over DNS, including a SOCKS proxy. You can download DNScapy from [_https://github.com/FedericoCeratto/dnscapy_](https://github.com/FedericoCeratto/dnscapy).
- **DNScat or DNScat-P:** This Java-based tool, created by Tadeusz Pietraszek, supports bidirectional communication through DNS. You can download DNScat from [_https://github.com/iagox86/dnscat2_](https://github.com/iagox86/dnscat2).
- **DNScat2 (DNScat-B):** Written by Ron Bowes, this tool runs on Linux, macOS, and Windows. DNScat2 encodes DNS requests in NetBIOS encoding or hex encoding. You can download DNScat2 from [_https://github.com/iagox86/dnscat2_](https://github.com/iagox86/dnscat2).
- **Heyoka:** This Windows-based tool written in C supports bidirectional tunneling for data exfiltration. You can download Heyoka from [_http://heyoka.sourceforge.net_](http://heyoka.sourceforge.net).
- **iodine:** Written by Bjorn Andersson and Erik Ekman in C, iodine runs on Linux, macOS, and Windows, and it can even be ported to Android. You can download iodine from [_https://code.kryo.se/iodine/_](https://code.kryo.se/iodine/).
- **sods:** Originally written in Perl by Dan Kaminsky, this tool is used to set up an SSH tunnel over DNS or for file transfer. The requests are Base32 encoded, and responses are Base64-encoded TXT records. You can download sods from [_https://github.com/msantos/sods_](https://github.com/msantos/sods).
- **psudp:** Developed by Kenton Born, this tool injects data into existing DNS requests by modifying the IP/UDP header lengths. You can obtain additional information about psudp from [_https://pdfs.semanticscholar.org/0e28/637370748803bcefa5b89ce8b48cf0422adc.pdf_](https://pdfs.semanticscholar.org/0e28/637370748803bcefa5b89ce8b48cf0422adc.pdf).
- **Feederbot and Moto:** Attackers have used this malware with DNS to steal sensitive information from many organizations. You can obtain additional information about these tools from [_https://chrisdietri.ch/post/feederbot-botnet-using-dns-command-and-control/_](https://chrisdietri.ch/post/feederbot-botnet-using-dns-command-and-control/).

Some of these tools were not created for stealing data, but cybercriminals have appropriated them for their own purposes.

---

### Practice - Common Tools for Evasion

Hackers can evade security protections and detection. Penetration testers should use similar tools and techniques to do the same.

Match the evasion tool or technique to its description.

![[Pasted image 20240620093705.png]]

